---
title: '@hono/zod-openapiã‚’ä½¿ã£ã¦ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™ºã‚’ã‚„ã£ã¦ã¿ã‚‹'
emoji: 'ğŸ”¥'
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['Hono', 'OpenAPI', 'Zod', 'ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™º']
published: false
---

OpenAPI ã®ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™ºæ‰‹æ³•ã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®ã‚ˆã†ãª Zod ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã‚’èµ·ç‚¹ã«ã—ãŸé–‹ç™ºãƒ•ãƒ­ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚

```mermaid
%%{init: { 'theme': 'forest' } }%%
graph TB
    A(Zod ã‚¹ã‚­ãƒ¼ãƒå®šç¾©) --> B(Hono APIå®Ÿè£…)
    B-->|@hono/zod-openapi| C(OpenAPI ã‚¹ã‚­ãƒ¼ãƒç”Ÿæˆ)
    C -->|Orval| D(å‹)
    C -->|Orval| E(Tanstack Queryã®ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯)
    C -->|Orval| F(ãƒ¢ãƒƒã‚¯)
```

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å…¨ä½“åƒ

pnpm ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’åˆ©ç”¨ã—ãŸãƒ¢ãƒãƒ¬ãƒæ§‹æˆã¨ãªã£ã¦ã„ã¾ã™ã€‚

```
.
â”œâ”€â”€ apps
â”‚Â Â  â”œâ”€â”€ api
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ drizzle
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ migrations
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ drizzle.config.ts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ package.json
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ scripts
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ generate-openapi.ts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ src
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ db
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ schemas
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ pets.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ index.ts
â”‚Â Â  â”‚Â Â  â””â”€â”€ wrangler.jsonc
â”‚Â Â  â”œâ”€â”€ front
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ index.html
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ orval.config.ts
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ package.json
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ src
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ api
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ custom-instance.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ App.css
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ App.tsx
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ generated
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ models
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ pets
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ swaggerPetstore.msw.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ swaggerPetstore.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ index.css
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ main.tsx
â”‚Â Â  â”‚Â Â  â””â”€â”€ vite.config.ts
â”‚Â Â  â””â”€â”€ openapi.yaml
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-lock.yaml
â””â”€â”€ pnpm-workspace.yaml
```

## é–‹ç™ºã®æµã‚Œ

1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ Zod ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©
2. Hono ã§ API å®Ÿè£…
3. OpenAPI ã‚¹ã‚­ãƒ¼ãƒç”Ÿæˆ
4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ Orval ã«ã‚ˆã‚‹å‹ã‚„ Tanstack Query ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ç­‰ã‚’ç”Ÿæˆ
5. ç”Ÿæˆã•ã‚ŒãŸå‹ã¨ API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆ©ç”¨ã—ã¦å®Ÿè£…

## API å®Ÿè£…

### Zod ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

Orval ã® sample ã«ã‚ã‚‹ OpenAPI ã‚¹ã‚­ãƒ¼ãƒã®`petstore.yaml`ã‚’å‚è€ƒã« Zod ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã€‚

https://github.com/orval-labs/orval/blob/master/samples/hono/hono-with-fetch-client/petstore.yaml

```ts
import { z } from '@hono/zod-openapi';

const PetSchema = z
  .object({
    id: z.number().int().openapi({ format: 'int64' }),
    name: z
      .string()
      .min(1, 'Name is required')
      .max(40)
      .openapi({ description: 'Name of the pet' }),
    tag: z
      .string()
      .min(1, 'Tag is required')
      .max(20)
      .openapi({ description: 'Type of the pet' }),
  })
  .openapi('Pet');

const PetsSchema = z.array(PetSchema).openapi('Pets');

const ErrorSchema = z
  .object({
    code: z.number().int().openapi({ example: 500, format: 'int32' }),
    message: z.string().openapi({ example: 'Internal Server Error' }),
  })
  .openapi('Error');
```

Zod ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒ OpenAPI ã‚¹ã‚­ãƒ¼ãƒã® properties ã®å‹ã‚„åˆ¶ç´„ã«å¤‰æ›ã•ã‚Œã‚‹ã€‚
ä¾‹ãˆã°ã€`min()`, `max()` ã¯ OpenAPI ã‚¹ã‚­ãƒ¼ãƒç”Ÿæˆã«ã‚ˆã‚Š `minimum`, `maximum`ã§å‡ºåŠ›ã•ã‚Œã‚‹ã€‚
`exclusiveMinimum`,`exclusiveMaximum` ã§è¡¨ç¾ã—ãŸã„å ´åˆã¯ `gt()`,`lt()` ã‚’ä½¿ã†ã€‚

### Hono ã§ API å®Ÿè£…

```ts:apps/api/src/index.ts
import type { D1Database } from '@cloudflare/workers-types';
import { z, createRoute, OpenAPIHono } from '@hono/zod-openapi';
import { swaggerUI } from '@hono/swagger-ui';
import { drizzle } from 'drizzle-orm/d1';
import { eq } from 'drizzle-orm';
import { pets } from './db/schemas/pets';
import { cors } from 'hono/cors';

type Bindings = {
  DB: D1Database;
};

// Zod schemaå®šç¾©ã¯çœç•¥

const app = new OpenAPIHono<{ Bindings: Bindings }>().basePath('/api');

app.use('/api/*', cors())

// GET /pets - List all pets
app.openapi(
  createRoute({
    method: 'get',
    path: '/pets',
    summary: 'List all pets',
    operationId: 'listPets',
    tags: ['pets'],
    request: {
      query: z.object({
        limit: z.string().optional().openapi({
          description: 'How many items to return at one time (max 100)',
        }),
      }),
    },
    responses: {
      200: {
        description: 'A paged array of pets',
        content: {
          'application/json': {
            schema: PetsSchema,
          },
        },
      },
    },
  }),
  async (c) => {
    const db = drizzle(c.env.DB);
    const { limit } = c.req.valid('query');
    const limitNum = limit ? parseInt(limit) : undefined;

    const allPets = await db
      .select()
      .from(pets)
      .limit(limitNum || 100)
      .all();
    return c.json(allPets, 200);
  }
);

// POST /pets - Create a pet
app.openapi(
  createRoute({
    method: 'post',
    path: '/pets',
    summary: 'Create a pet',
    operationId: 'createPet',
    tags: ['pets'],
    request: {
      body: {
        required: true,
        content: {
          'application/json': {
            schema: PetSchema.omit({ id: true }),
          },
        },
      },
    },
    responses: {
      200: {
        description: 'Created Pet',
        content: {
          'application/json': {
            schema: PetSchema,
          },
        },
      },
      default: {
        description: 'unexpected error',
        content: {
          'application/json': {
            schema: ErrorSchema,
          },
        },
      },
    },
  }),
  async (c) => {
    const db = drizzle(c.env.DB);
    const body = c.req.valid('json');

    const result = await db
      .insert(pets)
      .values({
        name: body.name,
        tag: body.tag,
      })
      .returning()
      .get();

    return c.json(result, 200);
  }
);

// PUT /pets - Update a pet
app.openapi(
  createRoute({
    method: 'put',
    path: '/pets',
    summary: 'Update a pet',
    operationId: 'updatePets',
    tags: ['pets'],
    request: {
      body: {
        required: true,
        content: {
          'application/json': {
            schema: PetSchema,
          },
        },
      },
    },
    responses: {
      200: {
        description: 'Created Pet',
        content: {
          'application/json': {
            schema: PetSchema,
          },
        },
      },
      default: {
        description: 'unexpected error',
        content: {
          'application/json': {
            schema: ErrorSchema,
          },
        },
      },
    },
  }),
  async (c) => {
    const db = drizzle(c.env.DB);
    const updatedPet = c.req.valid('json');

    const result = await db
      .update(pets)
      .set({
        name: updatedPet.name,
        tag: updatedPet.tag,
      })
      .where(eq(pets.id, updatedPet.id))
      .returning()
      .get();

    if (!result) {
      return c.json({ code: 404, message: 'Pet not found' }, 404);
    }

    return c.json(result, 200);
  }
);

// GET /pets/{petId} - Info for a specific pet
app.openapi(
  createRoute({
    method: 'get',
    path: '/pets/{petId}',
    summary: 'Info for a specific pet',
    operationId: 'showPetById',
    tags: ['pets'],
    request: {
      params: z.object({
        petId: z.string().openapi({
          description: 'The id of the pet to retrieve',
        }),
      }),
    },
    responses: {
      200: {
        description: 'Expected response to a valid request',
        content: {
          'application/json': {
            schema: PetSchema,
          },
        },
      },
      default: {
        description: 'unexpected error',
        content: {
          'application/json': {
            schema: ErrorSchema,
          },
        },
      },
    },
  }),
  async (c) => {
    const db = drizzle(c.env.DB);
    const { petId } = c.req.valid('param');

    const pet = await db
      .select()
      .from(pets)
      .where(eq(pets.id, parseInt(petId)))
      .get();

    if (!pet) {
      return c.json({ code: 404, message: 'Pet not found' }, 404);
    }

    return c.json(pet, 200);
  }
);

export { app };
export default app;
```

Swagger UI ã§ OpenAPI ã‚¹ã‚­ãƒ¼ãƒã‚’ Web ç”»é¢ã§ç¢ºèªã§ãã‚‹ã€‚
Orval ã® v6.9.0 ã§ OpenAPI v3.1 ã®ã‚µãƒãƒ¼ãƒˆãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ãŒã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰èª­ã¿å–ã‚Œãšä¸€æ—¦ v3 ç³»ã§ç”Ÿæˆã—ã¾ã—ãŸã€‚

https://github.com/orval-labs/orval/releases/tag/v6.9.0

```ts:apps/api/src/index.ts
app.doc('/doc', {
  openapi: '3.0.0',
  info: {
    version: '1.0.0',
    title: 'Swagger Petstore',
    license: {
      name: 'MIT',
    },
  },
});

app.get('/doc/ui', swaggerUI({ url: '/doc' }));
```

## OpenAPI ã‚¹ã‚­ãƒ¼ãƒç”Ÿæˆ

ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```ts:apps/api/scripts/generate-openapi.ts
import { writeFileSync } from 'node:fs';
import { app } from '../src/index.js';
import yaml from 'yaml';

const doc = app.getOpenAPIDocument(
  {
    openapi: '3.0.0',
    info: {
      version: '1.0.0',
      title: 'Swagger Petstore',
      license: { name: 'MIT' },
    },
  },
  {
    unionPreferredType: 'oneOf',
  }
);

// YAMLå‡ºåŠ›
writeFileSync('../openapi.yaml', yaml.stringify(doc));
console.log('âœ… openapi.yaml generated');

// JSONå‡ºåŠ›
// writeFileSync('../openapi.json', JSON.stringify(doc, null, 2));
// console.log('âœ… openapi.json generated');
```

```json:package.json
{
  "scripts": {
    "openapi:generate": "tsx scripts/generate-openapi.ts",
  }
}
```

```sh
pnpm api openapi:generate

> schema-driven-development-otameshi@1.0.0 api /Users/kmkkiii/ghq/github.com/kmkkiii/schema-driven-development-otameshi
> pnpm -F api openapi:generate


> api@ openapi:generate /Users/kmkkiii/ghq/github.com/kmkkiii/schema-driven-development-otameshi/apps/api
> tsx scripts/generate-openapi.ts

âœ… openapi.yaml generated
```

## Orval ã§ OpenAPI ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰å‹ã‚„ Tanstack Query ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ç­‰ã‚’ç”Ÿæˆ

ç”Ÿæˆã™ã‚‹ API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ç¨®é¡ã‚„ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã®æ ¼ç´å…ˆç­‰ã‚’è¨­å®šã€‚

```ts:apps/front/orval.config.ts
import { defineConfig } from 'orval';

export default defineConfig({
  petstoreClient: {
    input: {
      target: '../openapi.yaml',
    },
    output: {
      mode: 'tags-split',
      client: 'react-query',
      target: 'src/generated/',
      schemas: 'src/generated/models',
      mock: true,
      httpClient: 'axios',
      override: {
        mutator: {
          path: './src/api/custom-instance.ts',
          name: 'customInstance',
        },
      },
    },
  },
});
```

```sh
pnpm front orval

> schema-driven-development-otameshi@1.0.0 front /Users/kmkkiii/ghq/github.com/kmkkiii/schema-driven-development-otameshi
> pnpm -F front orval


> front@0.0.0 orval /Users/kmkkiii/ghq/github.com/kmkkiii/schema-driven-development-otameshi/apps/front
> orval

ğŸ» orval v7.17.0 - A swagger client generator for typescript
ğŸ‰ petstoreClient - Your OpenAPI spec has been converted into ready to use orval!
```

ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã‚‹ã€‚

```
.
â”œâ”€â”€ apps
â”‚Â Â  â”œâ”€â”€ front
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ src
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ generated
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ models
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ createPetBody.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ createPetsBodyItem.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ error.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ index.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ listPetsParams.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ pet.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ pets.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ pets
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ pets.msw.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ pets.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ swaggerPetstore.msw.ts
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ swaggerPetstore.ts
```

## ç”Ÿæˆã•ã‚ŒãŸ Tanstack Query ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’ä½¿ã£ã¦ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

Tanstack Query ã‚’ä½¿ã†æº–å‚™ã€‚

```ts:apps/front/src/main.tsx
import { StrictMode } from 'react';
import { createRoot } from 'react-dom/client';
import './index.css';
import App from './App.tsx';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';

const queryClient = new QueryClient();

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <QueryClientProvider client={queryClient}>
      <App />
    </QueryClientProvider>
  </StrictMode>
);
```

ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’ä½¿ã£ã¦å®Ÿè£…ã€‚

```ts:apps/front/src/App.tsx
import './App.css';
import { useListPets } from './generated/pets/pets';

function App() {
  const { data: pets, isLoading, error } = useListPets();

  if (isLoading) {
    return <div>Loading...</div>;
  }

  if (error) {
    return <div>Error: {error.message}</div>;
  }

  return (
    <>
      <h2>Pets</h2>
      <ul>
        {pets?.map((pet) => (
          <li key={pet.id}>{pet.name}</li>
        ))}
      </ul>
    </>
  );
}

export default App;
```

## ãŠã‚ã‚Š

Zod ã‚’ä½¿ã†ã“ã¨ã§ã‚¹ã‚­ãƒ¼ãƒã¨ä¸€ç·’ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚å®šç¾©ã§ãã‚‹ã“ã¨ã€Orval ã«ã‚ˆã‚‹ å‹ã‚„ Tanstack Query ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ç­‰ã®ç”Ÿæˆã§å®Ÿè£…ã®å…±é€šåŒ–ã‚’è¡Œãˆã‚‹ã“ã¨ã§å¿«é©ãªé–‹ç™ºä½“é¨“ã‚’ä½“é¨“ã§ãã¾ã—ãŸã€‚

æœ€è¿‘ã¯ oRPC ã‚‚æ°—ã«ãªã£ã¦ã„ã‚‹ã®ã§ãã¡ã‚‰ã‚‚è§¦ã£ã¦ã¿ãŸã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚

ã“ã“ã¾ã§èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼
